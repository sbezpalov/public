# Документация для скрипта установки платформы

## Обзор
Этот скрипт PowerShell автоматизирует установку и настройку платформы 1С на основе настроек, указанных в конфигурационном файле (`PlatformInstall.ini`). Скрипт выполняет следующие действия:

1. Проверяет конфигурационный файл и среду.
2. Проверяет текущую установленную версию платформы 1С.
3. Устанавливает или пропускает установку в зависимости от версии.
4. Копирует необходимые конфигурационные файлы (`hasp.ini`).
5. Регистрирует компонент `comcntr.dll`.

## Требования
- Операционная система Windows.
- PowerShell v5.1 или выше.
- Права администратора.

## Шаги установки
1. Убедитесь, что конфигурационный файл (`PlatformInstall.ini`) доступен.
2. Сохраните скрипт и конфигурационный файл в безопасную директорию.
3. Запустите скрипт с правами администратора:
   ````powershell
   .\PlatformInstall.ps1
   ````

## Конфигурационный файл (`PlatformInstall.ini`)
Скрипт использует конфигурационный файл для определения параметров установки. Пример конфигурации:

````ini
[INSTALL]
DistrDir=\\Server\Scripts\bin\
ProductCode={B26B9BD7-DA36-6A6B-9729-A559619283F6}
ProductVersion=8.3.25.1445
UpgradeCode={76AA2121-1E8C-4993-B980-49916CA2387C}
MsiPackage=1CEnterprise 8 (x86-64).msi
MsiOptions=THICKCLIENT=1 THINCLIENT=1 WEBSERVER=0 SERVER=0 CONFREPOSSERVER=0 CONVERTER77=0 SERVERCLIENT=1 LANGUAGES=RU
HaspIni=\\Server\Scripts\nethasp.ini
````

### Обязательные поля
- `DistrDir`: Директория, содержащая установочные файлы.
- `ProductCode`: GUID продукта.
- `ProductVersion`: Версия платформы для установки.
- `MsiPackage`: Название MSI пакета.
- `MsiOptions`: Опции, передаваемые MSI установщику.
- `HaspIni`: Путь к файлу `hasp.ini`.

## Особенности скрипта

### Логирование
Скрипт записывает сообщения со следующими уровнями:
- **INFO**: Общий прогресс и шаги.
- **ERROR**: Проблемы, вызывающие завершение скрипта.

### Функции
#### Log-Event
Записывает сообщения с указанным уровнем.

#### Catch-Error
Обрабатывает и записывает ошибки, затем завершает скрипт.

#### Get-IniContent
Анализирует конфигурационный файл и возвращает его содержимое в виде словаря.

#### Get-InstalledVersion
Получает текущую установленную версию платформы 1С из реестра Windows.

#### Copy-HaspIni
Копирует файл `hasp.ini` в соответствующую директорию (`C:\Program Files\1cv8\conf` или эквивалент).

#### Register-ComCntrDll
Регистрирует файл `comcntr.dll` из директории `bin` установленной платформы.

## Последовательность выполнения
1. Скрипт читает и проверяет конфигурационный файл.
2. Проверяет установленную версию платформы:
   - Если установленная версия новее или равна целевой версии, скрипт пропускает установку.
   - В противном случае продолжает установку.
3. Скрипт устанавливает MSI пакет, используя параметры, указанные в конфигурационном файле.
4. Копирует файл `hasp.ini` в требуемую директорию.
5. Скрипт регистрирует компонент `comcntr.dll`.

## Примеры
Запустите скрипт для установки или обновления платформы:
````powershell
.\PlatformInstall.ps1
````

## Устранение неполадок
- **Конфигурационный файл не найден**: Убедитесь, что путь к `PlatformInstall.ini` правильный.
- **HASP.INI не найден**: Проверьте, существует ли файл по указанному пути.
- **Не удалось зарегистрировать DLL**: Убедитесь, что файл `comcntr.dll` существует в директории `bin`.

## Лицензия
Этот скрипт распространяется под лицензией GPLv3.

## Контакты

    Автор: Сергей Безпалов
    Email: sergey@bezpalov.com

Спасибо за использование этого шаблона! Если у вас есть вопросы, создайте Issue в репозитории.